# ==============================================================
# API GATEWAY CONFIGURATION (CLEAN VERSION)
# Compatible with: ELK Stack (Logging)
# ==============================================================

spring:
  application:
    name: api-gateway
  
  # Spring Cloud Gateway Configuration
  cloud:
    gateway:
      # Konfigurasi HTTP Client
      httpclient:
        connect-timeout: 5000
        response-timeout: 30s
      
      # Konfigurasi CORS Global (PENTING UNTUK SWAGGER)
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
            allowedHeaders: "*"

      # Daftar Routes
      routes:
        # ==========================================
        # 1. ROUTE KHUSUS SWAGGER (Docs Aggregator)
        # ==========================================
        - id: openapi-anggota
          uri: lb://service-anggota
          predicates:
            - Path=/v3/api-docs/service-anggota
          filters:
            - RewritePath=/v3/api-docs/service-anggota, /v3/api-docs

        - id: openapi-buku
          uri: lb://service-buku
          predicates:
            - Path=/v3/api-docs/service-buku
          filters:
            - RewritePath=/v3/api-docs/service-buku, /v3/api-docs

        - id: openapi-peminjaman
          uri: lb://service-peminjaman
          predicates:
            - Path=/v3/api-docs/service-peminjaman
          filters:
            - RewritePath=/v3/api-docs/service-peminjaman, /v3/api-docs

        - id: openapi-pengembalian
          uri: lb://service-pengembalian
          predicates:
            - Path=/v3/api-docs/service-pengembalian
          filters:
            - RewritePath=/v3/api-docs/service-pengembalian, /v3/api-docs

        # ==========================================
        # 2. ROUTE API UTAMA (Service Logic)
        # ==========================================
        
        # Service Anggota
        - id: service-anggota
          uri: lb://service-anggota
          predicates:
            - Path=/api/anggota/**
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                methods: GET,POST,PUT,DELETE
      
        # Service Buku
        - id: service-buku
          uri: lb://service-buku
          predicates:
            - Path=/api/buku/**
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                methods: GET,POST,PUT,DELETE
      
        # Service Peminjaman
        - id: service-peminjaman
          uri: lb://service-peminjaman
          predicates:
            - Path=/api/peminjaman/**
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                methods: GET,POST,PUT,DELETE
      
        # Service Pengembalian
        - id: service-pengembalian
          uri: lb://service-pengembalian
          predicates:
            - Path=/api/pengembalian/**
          filters:
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                methods: GET,POST,PUT,DELETE
    
    # Load Balancer Configuration
    loadbalancer:
      ribbon:
        enabled: false
      cache:
        enabled: true
        ttl: 5s
        capacity: 256

server:
  port: 8080
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain
  http2:
    enabled: true
  shutdown: graceful

# Spring Lifecycle
spring.lifecycle.timeout-per-shutdown-phase: 30s

# Eureka Client Configuration
eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_SERVER_URL:http://localhost:8761/eureka/}
    register-with-eureka: true
    fetch-registry: true
    registry-fetch-interval-seconds: 10
  instance:
    prefer-ip-address: true
    hostname: api-gateway
    instance-id: ${spring.application.name}:${random.value}
    metadata-map:
      management.port: ${server.port}
      management.context-path: /actuator

# Monitoring & Management (CLEAN VERSION)
management:
  endpoints:
    web:
      exposure:
        # Hapus 'prometheus' dan 'metrics'
        include: health,info,gateway,env,loggers
      base-path: /actuator
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true
  health:
    livenessState:
      enabled: true
    readinessState:
      enabled: true
    circuitbreakers:
      enabled: true
  # Hapus bagian Zipkin, Tracing, dan Metrics export disini

# Resilience4j Configuration (Tetap dipertahankan untuk kestabilan)
resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 10s
        failureRateThreshold: 50
    instances:
      anggotaCircuitBreaker:
        baseConfig: default
      bukuCircuitBreaker:
        baseConfig: default
      peminjamanCircuitBreaker:
        baseConfig: default
      pengembalianCircuitBreaker:
        baseConfig: default
  
  retry:
    configs:
      default:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
    instances:
      anggotaRetry:
        baseConfig: default
      bukuRetry:
        baseConfig: default
      peminjamanRetry:
        baseConfig: default
      pengembalianRetry:
        baseConfig: default

# Logging
logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web: INFO
    com.perpustakaan: DEBUG
    io.github.resilience4j: DEBUG
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n'
  file:
    name: logs/api-gateway.log
    max-size: 10MB
    max-history: 30

# SWAGGER ENABLED
springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    urls:
      - name: Service Anggota
        url: /v3/api-docs/service-anggota
      - name: Service Buku
        url: /v3/api-docs/service-buku
      - name: Service Peminjaman
        url: /v3/api-docs/service-peminjaman
      - name: Service Pengembalian
        url: /v3/api-docs/service-pengembalian