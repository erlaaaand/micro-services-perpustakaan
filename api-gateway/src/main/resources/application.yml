# Fixed API Gateway Configuration
# Spring Cloud Gateway Server MVC Compatible with Swagger

spring:
  application:
    name: api-gateway
  
  # Spring Cloud Gateway MVC Configuration
  cloud:
    gateway:
      mvc:
        # HTTP Timeouts
        http-client:
          connect-timeout: 5000
          response-timeout: 30s
        
        # Routes Configuration
        routes:
          # Route untuk Service Anggota
          - id: service-anggota
            uri: lb://service-anggota
            predicates:
              - Path=/api/anggota/**
            filters:
              - StripPrefix=0
              - name: Retry
                args:
                  retries: 3
                  statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                  methods: GET,POST,PUT,DELETE
                  backoff:
                    firstBackoff: 50ms
                    maxBackoff: 500ms
                    factor: 2
                    basedOnPreviousValue: false
        
          # Route untuk Service Buku
          - id: service-buku
            uri: lb://service-buku
            predicates:
              - Path=/api/buku/**
            filters:
              - StripPrefix=0
              - name: Retry
                args:
                  retries: 3
                  statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                  methods: GET,POST,PUT,DELETE
                  backoff:
                    firstBackoff: 50ms
                    maxBackoff: 500ms
                    factor: 2
        
          # Route untuk Service Peminjaman
          - id: service-peminjaman
            uri: lb://service-peminjaman
            predicates:
              - Path=/api/peminjaman/**
            filters:
              - StripPrefix=0
              - name: Retry
                args:
                  retries: 3
                  statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                  methods: GET,POST,PUT,DELETE
                  backoff:
                    firstBackoff: 50ms
                    maxBackoff: 500ms
                    factor: 2
        
          # Route untuk Service Pengembalian
          - id: service-pengembalian
            uri: lb://service-pengembalian
            predicates:
              - Path=/api/pengembalian/**
            filters:
              - StripPrefix=0
              - name: Retry
                args:
                  retries: 3
                  statuses: BAD_GATEWAY,SERVICE_UNAVAILABLE
                  methods: GET,POST,PUT,DELETE
                  backoff:
                    firstBackoff: 50ms
                    maxBackoff: 500ms
                    factor: 2
    
    # Load Balancer Configuration
    loadbalancer:
      ribbon:
        enabled: false
      cache:
        enabled: true
        ttl: 5s
        capacity: 256

server:
  port: 8080
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain
  http2:
    enabled: true
  shutdown: graceful

# Spring Lifecycle
spring.lifecycle.timeout-per-shutdown-phase: 30s

# Eureka Client Configuration
eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE:http://eureka-server:8761/eureka/}
    register-with-eureka: true
    fetch-registry: true
    registry-fetch-interval-seconds: 10
    eureka-server-connect-timeout-seconds: 15
    eureka-server-read-timeout-seconds: 15
  instance:
    prefer-ip-address: false
    hostname: api-gateway
    instance-id: ${spring.application.name}:${random.value}
    lease-renewal-interval-in-seconds: 10
    lease-expiration-duration-in-seconds: 30
    metadata-map:
      management.port: ${server.port}
      management.context-path: /actuator
      zone: zone1

# Monitoring & Management
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,metrics,gateway,env,loggers
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
    gateway:
      enabled: true
  health:
    livenessState:
      enabled: true
    readinessState:
      enabled: true
    circuitbreakers:
      enabled: true
    ratelimiters:
      enabled: true
  tracing:
    sampling:
      probability: 1.0
  zipkin:
    tracing:
      endpoint: ${MANAGEMENT_ZIPKIN_TRACING_ENDPOINT:http://zipkin:9411/api/v2/spans}
  metrics:
    tags:
      application: ${spring.application.name}
      environment: ${ENVIRONMENT:dev}
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
      slo:
        http.server.requests: 50ms,100ms,200ms,500ms,1s,2s

# Resilience4j Configuration untuk MVC Gateway
resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 10s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
        recordExceptions:
          - org.springframework.web.client.HttpServerErrorException
          - java.io.IOException
          - java.util.concurrent.TimeoutException
        ignoreExceptions:
          - org.springframework.web.client.HttpClientErrorException
    instances:
      anggotaCircuitBreaker:
        baseConfig: default
      bukuCircuitBreaker:
        baseConfig: default
      peminjamanCircuitBreaker:
        baseConfig: default
      pengembalianCircuitBreaker:
        baseConfig: default
  
  timelimiter:
    configs:
      default:
        timeoutDuration: 5s
        cancelRunningFuture: true
    instances:
      anggotaCircuitBreaker:
        baseConfig: default
      bukuCircuitBreaker:
        baseConfig: default
      peminjamanCircuitBreaker:
        baseConfig: default
      pengembalianCircuitBreaker:
        baseConfig: default
  
  retry:
    configs:
      default:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
        retryExceptions:
          - org.springframework.web.client.ResourceAccessException
          - java.io.IOException
        ignoreExceptions:
          - org.springframework.web.client.HttpClientErrorException
    instances:
      anggotaRetry:
        baseConfig: default
      bukuRetry:
        baseConfig: default
      peminjamanRetry:
        baseConfig: default
      pengembalianRetry:
        baseConfig: default

# Logging
logging:
  level:
    root: INFO
    org.springframework.cloud.gateway.server.mvc: DEBUG
    org.springframework.cloud.loadbalancer: DEBUG
    org.springframework.web: INFO
    com.perpustakaan: DEBUG
    io.github.resilience4j: DEBUG
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n'
    file: '%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n'
  file:
    name: logs/api-gateway.log
    max-size: 10MB
    max-history: 30

# SWAGGER DISABLED ON GATEWAY - Access services directly
springdoc:
  api-docs:
    enabled: false
  swagger-ui:
    enabled: false